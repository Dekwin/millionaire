<div class="main-class">
    <p>Управление вопросами игры <strong>Миллионер</strong>.</p>

    <ul>
        <li>Изменение, добавление и удаление данных</li>
    </ul>

    <div id="table" class="table-editable">
        <span class="table-add glyphicon glyphicon-plus"></span>
        <table class="table">
            <tr updated added>

                <th field = "id">ID</th>
                <th field = "updated_time">Обновлено</th>
                <th field = "level">Сложность</th>
                <th field = "text">Вопрос</th>
                <th field = "answer1">Первый ответ</th>
                <th field = "answer2">Второй ответ</th>
                <th field = "answer3">Третий ответ</th>
                <th field = "answer4">Четвертый ответ</th>
                <th field = "true_answer">№ верного ответа</th>
            </tr>

            {{#each this}}
            <tr>
                <td contenteditable="false">{{id}}</td>
                <td contenteditable="false">{{updated_time}}</td>
                <td contenteditable="true">{{level}}</td>
                <td contenteditable="true">{{text}}</td>
                <td contenteditable="true">{{answer1}}</td>
                <td contenteditable="true">{{answer2}}</td>
                <td contenteditable="true">{{answer3}}</td>
                <td contenteditable="true">{{answer4}}</td>
                <td contenteditable="true">{{true_answer}}</td>
                <td>
                    <span class="table-remove glyphicon glyphicon-remove"></span>
                </td>
                <td>
                    <span class="table-up glyphicon glyphicon-arrow-up"></span>
                    <span class="table-down glyphicon glyphicon-arrow-down"></span>
                </td>
            </tr>
            {{/each}}
            <!--
            <tr>
                <td contenteditable="true">Stir Fry</td>
                <td contenteditable="true">stir-fry</td>
                <td>
                    <span class="table-remove glyphicon glyphicon-remove"></span>
                </td>
                <td>
                    <span class="table-up glyphicon glyphicon-arrow-up"></span>
                    <span class="table-down glyphicon glyphicon-arrow-down"></span>
                </td>
            </tr>
            -->
            <!-- This is our clonable table line -->
            <tr class="hide">

                <td contenteditable="false">NEW</td>
                <td contenteditable="false"><script>var date = new Date(); document.write(date.getTime())/*convertDate()*/</script></td>
                <td contenteditable="true">1</td>
                <td contenteditable="true">sample question?</td>
                <td contenteditable="true">answer1</td>
                <td contenteditable="true">answer2</td>
                <td contenteditable="true">answer3</td>
                <td contenteditable="true">answer4</td>
                <td contenteditable="true">1</td>
                <td>
                    <span class="table-remove glyphicon glyphicon-remove"></span>
                </td>
                <td>
                    <span class="table-up glyphicon glyphicon-arrow-up"></span>
                    <span class="table-down glyphicon glyphicon-arrow-down"></span>
                </td>
            </tr>
        </table>
    </div>

    <form name="myform" action="" method="POST">
        <input type="hidden" id="json" name="json" value="">
        <div align="center">
            <button id="export-btn" value="val" class="btn btn-primary" type="submit">Save Data</button>
            <br><br>
        </div>
    </form>

    <!--<button id="export-btn" class="btn btn-primary">Export Data</button>-->
    <p id="export"></p>
</div>


<style>
    // @import "compass/css3";



    .table-editable {
        position: relative;

    .glyphicon {
        font-size: 20px;
    }
    }

    .table-remove {
        color: #700;
        cursor: pointer;

    &:hover {
         color: #f00;
     }
    }

    .table-up, .table-down {
        color: #007;
        cursor: pointer;

    &:hover {
         color: #00f;
     }
    }

    .table-add {
        color: #070;
        cursor: pointer;
        position: absolute;
        top: 8px;
        right: 0;

    &:hover {
         color: #0b0;
     }
    }
</style>

<script>
    var $TABLE = $('#table');
    var $BTN = $('#export-btn');
    var $EXPORT = $('#export');
    var deletedRows = [];

    $('tr').click(function () {
        if($(this).attr("added")!='')
            $(this).attr("updated",'');
        //alert("clicked");
    });

    $('.table-add').click(function () {
        var $clone = $TABLE.find('tr.hide').clone(true).removeClass('hide table-line').attr("added",'');
        var $td = $clone.find('td');
        $td.eq(1).text(dt.getTime());
        $TABLE.find('table').append($clone);
    });

    $('.table-remove').click(function () {
//$(this).parents('tr').detach();
        var row = $(this).parents('tr');
        var $td = row.find('td');
        var id = $td.eq(0).text();
        if($.isNumeric(id)) {
            deletedRows.push({id:$td.eq(0).text()});
        }
        $(this).parents('tr').detach();
    });

    $('.table-up').click(function () {
        var $row = $(this).parents('tr');
        if ($row.index() === 1) return; // Don't go above the header
        $row.prev().before($row.get(0));
    });

    $('.table-down').click(function () {
        var $row = $(this).parents('tr');
        $row.next().after($row.get(0));
    });

    // A few jQuery helpers for exporting only
    jQuery.fn.pop = [].pop;
    jQuery.fn.shift = [].shift;

    $BTN.click(function () {
//var $rows = $TABLE.find('tr:not(:hidden)');
        //  var $rows = $TABLE.find('tr');
        var $rows = $TABLE.find("tr[updated='']");
        $rows.each(function () {
            console.log("head "+$(this).find("tr").toString());
        });

        var headers = [];
        var data = [];

// Get the headers (add special header logic here)
        $($rows.shift()).find('th:not(:empty)').each(function () {
            headers.push($(this).attr("field"));
        });

// Turn all existing rows into a loopable array
        $rows.each(function () {
            var $td = $(this).find('td');
            var h = {};

// Use the headers from earlier to name our hash keys
            headers.forEach(function (header, i) {
                h[header] = $td.eq(i).text();
            });

            data.push(h);
        });




        var $newRows = $TABLE.find("tr[added='']");


        var headers = [];
        var newRowsdata = [];

// Get the headers (add special header logic here)
        $($newRows.shift()).find('th:not(:empty)').each(function () {
            headers.push($(this).attr("field"));
        });

// Turn all existing rows into a loopable array
        $newRows.each(function () {
            var $td = $(this).find('td');
            var h = {};

// Use the headers from earlier to name our hash keys
            headers.forEach(function (header, i) {
                h[header] = $td.eq(i).text();
            });

            newRowsdata.push(h);
        });

// Output the result
        var result = {rows:{added: newRowsdata, updated:data, deleted:deletedRows}};
        $TABLE.find("tr[updated='']:not(:first)").removeAttr('updated');
        $TABLE.find("tr[added='']:not(:first)").removeAttr('added');
        deletedRows = [];

        var $JSON = $('#json');
        $JSON.attr('value',JSON.stringify(result));

        // $EXPORT.attr('value',JSON.stringify(result));
//$EXPORT.text(JSON.stringify(result));
    });

</script>